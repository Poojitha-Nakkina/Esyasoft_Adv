@{
    ViewData["Title"] = "User Management";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container my-5">
    <h2 class="mb-4">👥 User Management</h2>

    <!-- ✅ User Table -->
    <table class="table table-hover table-bordered align-middle text-center shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>User Name</th>
                <th>Display Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Last Login</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="userTableBody">
            <tr>
                <td colspan="8" class="text-center">Loading users...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- ✅ Edit Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId" />

                    <div class="mb-3">
                        <label for="editUserName" class="form-label">User Name</label>
                        <input type="text" class="form-control" id="editUserName" required />
                    </div>

                    <div class="mb-3">
                        <label for="editDisplayName" class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="editDisplayName" />
                    </div>

                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" required />
                    </div>

                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="editPhone" />
                    </div>

                    <div class="mb-3">
                        <label for="editRole" class="form-label">Role</label>
                        <select id="editRole" class="form-select">
                            <option value="ZoneAdmin">ZoneAdmin</option>
                            <option value="SuperAdmin">SuperAdmin</option>
                            <option value="Consumer">Consumer</option>
                        </select>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editActive" />
                        <label class="form-check-label" for="editActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ✅ JS Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const apiUrl = "https://localhost:7285/api/User";
    const token = localStorage.getItem("jwtToken");

    const editModal = new bootstrap.Modal(document.getElementById("editUserModal"));
    const userTableBody = document.getElementById("userTableBody");

    // ✅ Load all users
    async function loadUsers() {
        try {
            const res = await fetch(`${apiUrl}/AllUsers`, {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) throw new Error("Failed to fetch users");

            const users = await res.json();
            userTableBody.innerHTML = "";

            if (!users.length) {
                userTableBody.innerHTML = `<tr><td colspan="8" class="text-center">No users found.</td></tr>`;
                return;
            }

            users.forEach(user => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${user.userId}</td>
                    <td>${user.userName}</td>
                    <td>${user.displayName || "-"}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || "-"}</td>
                    <td>${user.role || "-"}</td>
                    <td>${user.lastLogin || "-"}</td>
                    <td>
                        <span class="badge ${user.active ? "bg-success" : "bg-danger"}">
                            ${user.active ? "Active" : "Inactive"}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" onclick='openEditModal(${JSON.stringify(user)})'>
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.userId})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>`;
                userTableBody.appendChild(row);
            });
        } catch (error) {
            console.error(error);
            userTableBody.innerHTML = `<tr><td colspan="8" class="text-danger text-center">⚠️ Error loading users.</td></tr>`;
        }
    }

    // ✅ Open Edit Modal
    function openEditModal(user) {
        document.getElementById("editUserId").value = user.userId;
        document.getElementById("editUserName").value = user.userName;
        document.getElementById("editDisplayName").value = user.displayName || "";
        document.getElementById("editEmail").value = user.email;
        document.getElementById("editPhone").value = user.phone || "";
        document.getElementById("editRole").value = user.role || "Consumer";
        document.getElementById("editActive").checked = user.active;
        editModal.show();
    }

    // ✅ Update User
    document.getElementById("editUserForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("editUserId").value;

        const updatedUser = {
            userId: parseInt(id),
            userName: document.getElementById("editUserName").value,
            displayName: document.getElementById("editDisplayName").value,
            email: document.getElementById("editEmail").value,
            phone: document.getElementById("editPhone").value,
            role: document.getElementById("editRole").value,
            active: document.getElementById("editActive").checked
        };

        try {
            const res = await fetch(`${apiUrl}/UpdateUser/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(updatedUser)
            });

            if (res.ok) {
                alert("✅ User updated successfully!");
                editModal.hide();
                loadUsers();
            } else {
                const msg = await res.text();
                alert("❌ Failed to update user.\n" + msg);
            }
        } catch (err) {
            alert("⚠️ Error updating user.");
            console.error(err);
        }
    });

    // ✅ Delete User
    async function deleteUser(id) {
        if (!confirm("Are you sure you want to delete this user?")) return;

        try {
            const res = await fetch(`${apiUrl}/DeleteUser/${id}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });

            if (res.ok) {
                alert("🗑️ User deleted successfully!");
                loadUsers();
            } else {
                alert("❌ Failed to delete user.");
            }
        } catch (err) {
            alert("⚠️ Error deleting user.");
            console.error(err);
        }
    }

    // ✅ Initial Load
    loadUsers();
</script>