@{
    ViewData["Title"] = "Tariff Slabs Management";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container mt-5" id="tariffSlabSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Tariff Slabs</h2>
        <button id="addSlabBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSlabModal">
            ➕ Add Tariff Slab
        </button>
    </div>

    <!-- 🔽 Tariff Filter Dropdown -->
    <div class="mb-4">
        <label for="tariffFilter" class="form-label fw-semibold">Select Tariff Type</label>
        <select id="tariffFilter" class="form-select w-50">
            <option value="">-- Select Tariff --</option>
        </select>
    </div>

    <!-- Slab Table -->
    <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>Slab ID</th>
                <th>Tariff Name</th>
                <th>From (kWh)</th>
                <th>To (kWh)</th>
                <th>Rate per kWh</th>
                <th id="actionHeader">Actions</th>
            </tr>
        </thead>
        <tbody id="slabTableBody"></tbody>
    </table>
</div>

<!-- Add/Edit Slab Modal -->
<div class="modal fade" id="addSlabModal" tabindex="-1" aria-labelledby="addSlabModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="slabForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSlabModalLabel">Add Tariff Slab</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                    <input type="hidden" id="slabId" />
                    <div class="col-md-6">
                        <label class="form-label">Tariff Type</label>
                        <select id="tariffId" class="form-select" required></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">From (kWh)</label>
                        <input type="number" id="fromKwh" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">To (kWh)</label>
                        <input type="number" id="toKwh" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Rate per kWh</label>
                        <input type="number" id="ratePerKwh" class="form-control" step="0.01" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="saveSlabBtn">Save Slab</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const apiSlab = "https://localhost:7285/api/TariffSlab";
    const apiTariff = "https://localhost:7285/api/Tariffs";
    const token = localStorage.getItem("jwtToken");
    const role = (localStorage.getItem("role") || "").toLowerCase();

    let allSlabs = [];
    let allTariffs = [];

    document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById("tariffSlabSection").style.display = "block";
        await loadTariffs();
        await loadSlabs();

        if (role !== "superadmin" && role !== "zoneadmin") {
            document.getElementById("addSlabBtn").style.display = "none";
            document.getElementById("actionHeader").style.display = "none";
        }

        // Filter slabs when tariff changes
        document.getElementById("tariffFilter").addEventListener("change", filterSlabsByTariff);
    });

    // ✅ Load all tariffs
    async function loadTariffs() {
        const response = await fetch(`${apiTariff}/GetAllTariffs`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) return console.error("Error loading tariffs");

        allTariffs = await response.json();

        const tariffFilter = document.getElementById("tariffFilter");
        const tariffSelect = document.getElementById("tariffId");

        allTariffs.forEach(t => {
            const option = `<option value="${t.tariffId}">${t.name}</option>`;
            tariffFilter.innerHTML += option;
            tariffSelect.innerHTML += option;
        });
    }

    // ✅ Load all slabs initially
    async function loadSlabs() {
        const response = await fetch(`${apiSlab}/AllTariffSlabs`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (!response.ok) {
            console.error("Error fetching slabs:", response.status);
            return;
        }

        allSlabs = await response.json();
        renderSlabs(allSlabs);
    }

    // ✅ Filter slabs based on selected tariff
    function filterSlabsByTariff() {
        const selectedTariffId = parseInt(document.getElementById("tariffFilter").value);
        if (!selectedTariffId) renderSlabs(allSlabs);
        else {
            const filtered = allSlabs.filter(s => s.tariffId === selectedTariffId);
            renderSlabs(filtered);
        }
    }

    // ✅ Render slabs into table
    function renderSlabs(slabs) {
        const tbody = document.getElementById("slabTableBody");
        tbody.innerHTML = "";

        slabs.forEach(slab => {
            const tariff = allTariffs.find(t => t.tariffId === slab.tariffId);
            const tariffName = tariff ? tariff.name : "N/A";

            const actionButtons = (role === "superadmin" || role === "zoneadmin")
                ? `<td>
                        <button class="btn btn-warning btn-sm me-1" onclick="editSlab(${slab.slabId})">✏ Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSlab(${slab.slabId})">🗑 Delete</button>
                   </td>`
                : "";

            tbody.innerHTML += `
                <tr>
                    <td>${slab.slabId}</td>
                    <td>${tariffName}</td>
                    <td>${slab.fromKwh}</td>
                    <td>${slab.toKwh}</td>
                    <td>${slab.ratePerKwh}</td>
                    ${actionButtons}
                </tr>`;
        });
    }

    // ✅ Add/Edit Slab
    document.getElementById("slabForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const slabId = document.getElementById("slabId").value;
        const slabData = {
            slabId: slabId ? parseInt(slabId) : 0,
            tariffId: parseInt(document.getElementById("tariffId").value),
            fromKwh: parseFloat(document.getElementById("fromKwh").value),
            toKwh: parseFloat(document.getElementById("toKwh").value),
            ratePerKwh: parseFloat(document.getElementById("ratePerKwh").value)
        };

        const method = slabId ? "PUT" : "POST";
        const url = slabId ? `${apiSlab}/UpdateTariffSlab/${slabId}` : `${apiSlab}/createSlab`;

        const response = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(slabData)
        });

        if (response.ok) {
            alert(slabId ? "Slab updated successfully!" : "Slab added successfully!");
            bootstrap.Modal.getInstance(document.getElementById("addSlabModal")).hide();
            document.getElementById("slabForm").reset();
            await loadSlabs();
            filterSlabsByTariff();
        } else {
            alert("Error saving slab! Status: " + response.status);
        }
    });

    // ✅ Delete Slab
    async function deleteSlab(id) {
        if (!confirm("Are you sure you want to delete this slab?")) return;

        const response = await fetch(`${apiSlab}/DeleteTariffSlab/${id}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            alert("Slab deleted successfully!");
            await loadSlabs();
            filterSlabsByTariff();
        } else {
            alert("Error deleting slab!");
        }
    }

    // ✅ Edit Slab
    async function editSlab(id) {
        const response = await fetch(`${apiSlab}/slabId/${id}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (!response.ok) {
            alert("Error fetching slab details!");
            return;
        }

        const slab = await response.json();
        document.getElementById("slabId").value = slab.slabId;
        document.getElementById("tariffId").value = slab.tariffId;
        document.getElementById("fromKwh").value = slab.fromKwh;
        document.getElementById("toKwh").value = slab.toKwh;
        document.getElementById("ratePerKwh").value = slab.ratePerKwh;

        document.getElementById("addSlabModalLabel").textContent = "Edit Tariff Slab";
        new bootstrap.Modal(document.getElementById("addSlabModal")).show();
    }
</script>