@* 

@{
    ViewData["Title"] = "My Bills";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container mt-5">
    <h3 class="mb-4"><i class="bi bi-cash-stack"></i> My Bills</h3>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-bordered table-hover align-middle text-center mb-0">
            <thead class="table-dark text-white">
                <tr>
                    <th>Bill ID</th>
                    <th>Billing Month</th>
                    <th>Tariff Type</th>
                    <th>Total Consumption (kWh)</th>
                    <th>Total Bill (₹)</th>
                    <th>Status</th>
                    <th>Generated Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="billReadingsTableBody">
                <tr><td colspan="8" class="text-muted">Loading your bills...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="paymentForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel"><i class="bi bi-cash-stack"></i> Pay Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="paymentFormContent">
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Enter Amount (₹)</label>
                        <input type="number" min="0" step="0.01" class="form-control" id="paymentAmount" required />
                    </div>
                </div>
                <div id="paymentLoading" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Processing payment...</p>
                </div>
                <div id="paymentSuccess" class="alert alert-success d-none">
                    Payment completed successfully!
                </div>
            </div>
            <div class="modal-footer" id="paymentFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">OK</button>
            </div>
            <div class="modal-footer d-none" id="paymentSuccessFooter">
                <button type="button" class="btn btn-success" id="btnCloseSuccess" data-bs-dismiss="modal">Close</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const apiBase = "https://localhost:7285/api";
    const token = localStorage.getItem("jwtToken");
    const consumerId = localStorage.getItem("consumerId");

    let selectedBillId = null;

    $(document).ready(() => {
        loadBills();

        const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));

        // Open modal and pre-fill amount when pay button clicked
        window.payBill = function(billId) {
            selectedBillId = billId;

            // Reset modal state
            $("#paymentAmount").val('');
            $("#paymentFormContent").removeClass("d-none");
            $("#paymentLoading").addClass("d-none");
            $("#paymentSuccess").addClass("d-none");
            $("#paymentFooter").removeClass("d-none");
            $("#paymentSuccessFooter").addClass("d-none");

            paymentModal.show();
        }

        // Payment form submit handling
        $("#paymentForm").on("submit", async function(e) {
            e.preventDefault();

            const amount = parseFloat($("#paymentAmount").val());
            if (isNaN(amount) || amount <= 0) {
                alert("Please enter a valid amount greater than zero.");
                return;
            }

            // Hide form, show loading
            $("#paymentFormContent").addClass("d-none");
            $("#paymentFooter").addClass("d-none");
            $("#paymentLoading").removeClass("d-none");

            try {
                const res = await fetch(`${apiBase}/BillReading/PayBill/${selectedBillId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ amountPaid: amount }) // send amount in body if backend expects it
                });

                const data = await res.json();

                if (!res.ok) throw new Error(data.message || "Payment failed");

                // Hide loading, show success
                $("#paymentLoading").addClass("d-none");
                $("#paymentSuccess").removeClass("d-none");
                $("#paymentSuccessFooter").removeClass("d-none");

                // Reload bills on modal close
                $("#btnCloseSuccess").off("click").on("click", () => {
                    loadBills();
                    selectedBillId = null;
                });

            } catch (error) {
                alert("Error processing payment: " + error.message);
                // Reset modal so user can retry or cancel
                $("#paymentLoading").addClass("d-none");
                $("#paymentFormContent").removeClass("d-none");
                $("#paymentFooter").removeClass("d-none");
                console.error(error);
            }
        });
    });

    async function loadBills() {
        try {
            const res = await fetch(`${apiBase}/BillReading/ByCustomer/${consumerId}`, {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) throw new Error("Failed to load bills");

            const bills = await res.json();
            if (!bills.length) {
                $("#billReadingsTableBody").html(`<tr><td colspan="8" class="text-muted">No bills found.</td></tr>`);
                return;
            }

            let rows = "";
            bills.forEach(b => {
                const generatedDate = new Date(b.generatedDate).toLocaleString();
                const payButton = b.status === "Unpaid"
                    ? `<button class="btn btn-sm btn-success" onclick="payBill(${b.billId})"><i class="bi bi-credit-card"></i> Pay Now</button>`
                    : `<span class="badge bg-success">Paid</span>`;

                rows += `<tr>
                    <td>${b.billId}</td>
                    <td>${b.billingMonth}</td>
                    <td>${b.tariffType}</td>
                    <td>${b.totalConsumption}</td>
                    <td>${b.totalBill}</td>
                    <td>${b.status}</td>
                    <td>${generatedDate}</td>
                    <td>${payButton}</td>
                </tr>`;
            });

            $("#billReadingsTableBody").html(rows);
        } catch (error) {
            alert("Error loading bills: " + error.message);
            console.error(error);
        }
    }
</script> *@






@{
    ViewData["Title"] = "My Bills";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}


<div class="container mt-5">
    <h3 class="mb-4"><i class="bi bi-cash-stack"></i> My Bills</h3>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-bordered table-hover align-middle text-center mb-0">
            <thead class="table-dark text-white">
                <tr>
                    <th>Bill ID</th>
                    <th>Billing Month</th>
                    <th>Tariff Type</th>
                    <th>Total Consumption (kWh)</th>
                    <th>Total Bill (₹)</th>
                    <th>Remaining Balance (₹)</th> <!-- ✅ New column -->
                    <th>Status</th>
                    <th>Generated Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="billReadingsTableBody">
                <tr><td colspan="9" class="text-muted">Loading your bills...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ✅ Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="bi bi-credit-card"></i> Pay Bill
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Bill ID</label>
                    <input type="text" id="payBillId" class="form-control" readonly />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Total Bill (₹)</label>
                    <input type="number" id="payTotalBill" class="form-control" readonly />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Payment Mode</label>
                    <select id="payMode" class="form-select">
                        <option value="UPI">UPI</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="NetBanking">Net Banking</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Amount Paying (₹)</label>
                    <input type="number" id="payAmount" class="form-control" min="0" />
                </div>

                <div class="alert alert-info text-center fw-bold" id="remainingBalance">
                    Remaining Balance: ₹<span id="balanceValue">0</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmPaymentBtn">Confirm Payment</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const apiBase = "https://localhost:7285/api";
    const token = localStorage.getItem("jwtToken");
    const consumerId = localStorage.getItem("consumerId");
    let selectedBill = null;
    const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));

    $(document).ready(() => {
      loadBills();

      // Live balance update
      $("#payAmount").on("input", () => {
        const total = parseFloat($("#payTotalBill").val()) || 0;
        const paid = parseFloat($("#payAmount").val()) || 0;
        const remaining = Math.max(total - paid, 0);
        $("#balanceValue").text(remaining.toFixed(2));
      });

      $("#confirmPaymentBtn").click(async () => {
        await confirmPayment();
      });
    });

    function authHeader() {
      return { Authorization: "Bearer " + token };
    }

    async function loadBills() {
      try {
        const res = await fetch(`${apiBase}/BillReading/ByCustomer/${consumerId}`, {
          headers: authHeader(),
        });
        if (!res.ok) throw new Error("Failed to load bills");

        const bills = await res.json();
        if (!bills.length) {
          $("#billReadingsTableBody").html(
            `<tr><td colspan="9" class="text-muted">No bills found.</td></tr>`
          );
          return;
        }

        let rows = "";
        bills.forEach((b) => {
          const generatedDate = new Date(b.generatedDate).toLocaleString();
          const remainingBalance = (b.remainingBalance ?? (b.totalBill - (b.amountPaid ?? 0))).toFixed(2);
          const payButton =
            remainingBalance > 0
              ? `<button class="btn btn-sm btn-success" onclick="openPaymentModal(${b.billId}, ${b.totalBill}, ${remainingBalance})"><i class="bi bi-credit-card"></i> Pay Now</button>`
              : `<span class="badge bg-success">Paid</span>`;

          rows += `<tr>
                    <td>${b.billId}</td>
                    <td>${b.billingMonth}</td>
                    <td>${b.tariffType}</td>
                    <td>${b.totalConsumption}</td>
                    <td>${b.totalBill.toFixed(2)}</td>
                    <td>${remainingBalance}</td>
                    <td>${remainingBalance > 0 ? "Unpaid" : "Paid"}</td>
                    <td>${generatedDate}</td>
                    <td>${payButton}</td>
                  </tr>`;
        });

        $("#billReadingsTableBody").html(rows);
      } catch (error) {
        alert("Error loading bills: " + error.message);
        console.error(error);
      }
    }

    // 🧾 Open Modal
    function openPaymentModal(billId, totalBill, remainingBalance) {
      selectedBill = { billId, totalBill, remainingBalance };
      $("#payBillId").val(billId);
      $("#payTotalBill").val(remainingBalance);
      $("#payAmount").val(remainingBalance);
      $("#balanceValue").text("0.00");
      paymentModal.show();
    }

    // ✅ Confirm Payment
    async function confirmPayment() {
      if (!selectedBill) return alert("No bill selected!");

      const payAmount = parseFloat($("#payAmount").val()) || 0;
      const payMode = $("#payMode").val();

      if (payAmount <= 0) {
        alert("Please enter a valid payment amount.");
        return;
      }

      try {
        const res = await fetch(`${apiBase}/BillReading/PayBill/${selectedBill.billId}`, {
          method: "PUT",
          headers: { ...authHeader(), "Content-Type": "application/json" },
          body: JSON.stringify({
            amountPaid: payAmount,
            paymentMode: payMode,
            paymentDate: new Date().toISOString(),
          }),
        });

        if (!res.ok) throw new Error("Payment failed!");

        const data = await res.json();
        paymentModal.hide();

        alert(
          `✅ Payment Successful!\n\nBill ID: ${selectedBill.billId}\nAmount Paid: ₹${payAmount}\nPayment Mode: ${payMode}\nDate: ${new Date().toLocaleString()}`
        );

        loadBills();
      } catch (err) {
        console.error(err);
        alert("Error while confirming payment: " + err.message);
      }
    }
</script>

