@* @{
    ViewData["Title"] = "Bill Reading";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - Your App Name</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body>
    <div class="container mt-5">
        <h3 class="mb-4">
            <i class="bi bi-receipt"></i> Bill Reading
        </h3>
        <div class="row g-3 mb-4 align-items-end">
            <div class="col-md-4">
                <label for="consumerSelect" class="form-label fw-semibold">Select Consumer</label>
                <select id="consumerSelect" class="form-select">
                    <option value="">-- Select a Consumer --</option>
                </select>
            </div>

            <div class="col-md-4">
                <label for="statusSelect" class="form-label fw-semibold">Select Status</label>
                <select id="statusSelect" class="form-select">
                    <option value="">-- All Status --</option>
                    <option value="Paid">Paid</option>
                    <option value="Unpaid">Unpaid</option>
                </select>
            </div>

            <div class="col-md-3">
                <label for="monthSelect" class="form-label fw-semibold">Select Month</label>
                <select id="monthSelect" class="form-select">
                    <option value="">-- All Months --</option>
                </select>
            </div>

            <div class="col-md-1 d-grid">
                <button id="showBillsBtn" class="btn btn-primary">
                    <i class="bi bi-eye"></i>
                </button>
            </div>
        </div>

        <div class="table-responsive shadow-sm rounded">
            <table class="table table-bordered table-hover align-middle text-center mb-0">
                <thead class="table-dark text-white">
                    <tr>
                        <th>Bill ID</th>
                        <th>Consumer Name</th>
                        <th>Meter Serial No</th>
                        <th>Billing Month</th>
                        <th>Tariff Type</th>
                        <th>Total Consumption</th>
                        <th>Energy Charge</th>
                        <th>Tax Amount</th>
                        <th>Total Bill</th>
                        <th>Status</th>
                        <th>Generated Date</th>
                    </tr>
                </thead>
                <tbody id="billReadingsTableBody">
                    <tr><td colspan="11" class="text-muted">Loading bill readings...</td></tr>
                </tbody>
            </table>
        </div>

        <nav aria-label="Bill Readings Pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="paginationControls"></ul>
        </nav>
    </div>

    <!-- jQuery & Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiBase = "https://localhost:7285/api";
        const token = localStorage.getItem("jwtToken");

        let allBills = [];
        let consumerMap = {};
        let meterMap = {};
        let currentPage = 1;
        const itemsPerPage = 10;

        $(document).ready(function () {
            loadConsumers();
            loadMeters();
            loadAllBillReadings().then(() => {
                populateMonthSelect();
                displayBillReadings();
            });

            $("#consumerSelect, #statusSelect, #monthSelect").change(function () {
                currentPage = 1;
                displayBillReadings();
            });

            // ✅ Button click handler for month-based bills
            $("#showBillsBtn").click(fetchBillsForMonth);
        });

        function authHeader() {
            return { "Authorization": "Bearer " + token };
        }

        async function loadConsumers() {
            try {
                const res = await fetch(`${apiBase}/Consumer/AllConsumers`, { headers: authHeader() });
                if (!res.ok) throw new Error("Failed to load consumers");
                const consumers = await res.json();
                const $consumerSelect = $("#consumerSelect");
                $consumerSelect.html('<option value="">-- Select a Consumer --</option>');
                consumers.forEach(consumer => {
                    consumerMap[consumer.consumerId] = consumer.name || consumer.consumerId;
                    $consumerSelect.append(`<option value="${consumer.consumerId}">${consumer.name || consumer.consumerId}</option>`);
                });
            } catch (error) {
                alert("Error loading consumers: " + error.message);
                console.error(error);
            }
        }

        async function loadMeters() {
            try {
                const res = await fetch(`${apiBase}/Meters/AllMeters`, { headers: authHeader() });
                if (!res.ok) throw new Error("Failed to load meters");
                const meters = await res.json();
                meters.forEach(meter => {
                    meterMap[meter.meterId] = meter.meterSerialNo || meter.meterId;
                });
            } catch (error) {
                alert("Error loading meters: " + error.message);
                console.error(error);
            }
        }

        async function loadAllBillReadings() {
            try {
                const res = await fetch(`${apiBase}/BillReading/AllBills`, { headers: authHeader() });
                if (!res.ok) throw new Error("Failed to load bill readings");
                allBills = await res.json();
            } catch (error) {
                alert("Error loading bill readings: " + error.message);
                console.error(error);
            }
        }

        function populateMonthSelect() {
            const uniqueMonths = [...new Set(allBills.map(b => b.billingMonth))].sort();
            const $monthSelect = $("#monthSelect");
            $monthSelect.html('<option value="">-- All Months --</option>');
            uniqueMonths.forEach(month => {
                $monthSelect.append(`<option value="${month}">${month}</option>`);
            });
        }

        // ✅ NEW FUNCTION
        async function fetchBillsForMonth() {
            const month = $("#monthSelect").val();
            if (!month) {
                alert("Please select a month first!");
                return;
            }

            try {
                const res = await fetch(`${apiBase}/BillReading/Month/${month}`, { headers: authHeader() });
                if (!res.ok) throw new Error("Failed to fetch or generate bills");

                const data = await res.json();
                if (data.bills) {
                    allBills = data.bills;
                    displayBillReadings();
                    alert(data.message || `Bills for ${month} loaded successfully`);
                } else {
                    alert("Unexpected response format from server.");
                }
            } catch (error) {
                alert("Error generating bills: " + error.message);
                console.error(error);
            }
        }

        function displayBillReadings() {
            const consumerId = $("#consumerSelect").val();
            const status = $("#statusSelect").val();
            const month = $("#monthSelect").val();

            let billsToDisplay = allBills.filter(b => {
                return (!consumerId || b.consumerId == consumerId) &&
                       (!status || b.status === status) &&
                       (!month || b.billingMonth === month);
            });

            if (!billsToDisplay.length) {
                $("#billReadingsTableBody").html(`<tr><td colspan="11" class="text-muted">No bill readings found for the selected filters.</td></tr>`);
                $("#paginationControls").html('');
                return;
            }

            const totalPages = Math.ceil(billsToDisplay.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedBills = billsToDisplay.slice(startIndex, endIndex);

            let rows = "";
            paginatedBills.forEach(b => {
                const consumerName = consumerMap[b.consumerId] || b.consumerId;
                const meterSerialNo = meterMap[b.meterId] || b.meterId;
                const generatedDate = b.generatedDate ? new Date(b.generatedDate).toLocaleString() : '-';

                rows += `<tr>
                    <td>${b.billId}</td>
                    <td>${consumerName}</td>
                    <td>${meterSerialNo}</td>
                    <td>${b.billingMonth}</td>
                    <td>${b.tariffType}</td>
                    <td>${b.totalConsumption}</td>
                    <td>${b.energyCharge}</td>
                    <td>${b.taxAmount}</td>
                    <td>${b.totalBill}</td>
                    <td>${b.status}</td>
                    <td>${generatedDate}</td>
                </tr>`;
            });
            $("#billReadingsTableBody").html(rows);
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            if (totalPages <= 1) {
                $("#paginationControls").html('');
                return;
            }

            let paginationHtml = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
            </li>`;

            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
            }

            paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
            </li>`;

            $("#paginationControls").html(paginationHtml);
        }

        function changePage(page) {
            currentPage = page;
            displayBillReadings();
        }
    </script>
</body>
</html> *@


@{
    ViewData["Title"] = "Bill Reading";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - Your App Name</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body>
    <div class="container mt-5">
        <h3 class="mb-4">
            <i class="bi bi-receipt"></i> Bill Reading
        </h3>
        <div class="row g-3 mb-4 align-items-end">
            <div class="col-md-4">
                <label for="consumerSelect" class="form-label fw-semibold">Select Consumer</label>
                <select id="consumerSelect" class="form-select">
                    <option value="">-- Select a Consumer --</option>
                </select>
            </div>

            <div class="col-md-4">
                <label for="statusSelect" class="form-label fw-semibold">Select Status</label>
                <select id="statusSelect" class="form-select">
                    <option value="">-- All Status --</option>
                    <option value="Paid">Paid</option>
                    <option value="Unpaid">Unpaid</option>
                    <option value="Partially Paid">Partially Paid</option>
                </select>
            </div>

            <div class="col-md-3">
                <label for="monthSelect" class="form-label fw-semibold">Select Month</label>
                <select id="monthSelect" class="form-select">
                    <option value="">-- All Months --</option>
                </select>
            </div>

            <div class="col-md-1 d-grid">
                <button id="showBillsBtn" class="btn btn-primary">
                    <i class="bi bi-eye"></i>
                </button>
            </div>
        </div>

        <div class="table-responsive shadow-sm rounded">
            <table class="table table-bordered table-hover align-middle text-center mb-0">
                <thead class="table-dark text-white">
                    <tr>
                        <th>Bill ID</th>
                        <th>Consumer Name</th>
                        <th>Meter Serial No</th>
                        <th>Billing Month</th>
                        <th>Tariff Type</th>
                        <th>Total Consumption (kWh)</th>
                        <th>Energy Charge (₹)</th>
                        <th>Tax Amount (₹)</th>
                        <th>Total Bill (₹)</th>
                        <th>Remaining Balance (₹)</th> <!-- ✅ Added Column -->
                        <th>Status</th>
                        <th>Generated Date</th>
                    </tr>
                </thead>
                <tbody id="billReadingsTableBody">
                    <tr><td colspan="12" class="text-muted">Loading bill readings...</td></tr>
                </tbody>
            </table>
        </div>

        <nav aria-label="Bill Readings Pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="paginationControls"></ul>
        </nav>
    </div>

    <!-- jQuery & Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiBase = "https://localhost:7285/api";
        const token = localStorage.getItem("jwtToken");

        let allBills = [];
        let consumerMap = {};
        let meterMap = {};
        let currentPage = 1;
        const itemsPerPage = 10;

        $(document).ready(function () {
            loadConsumers();
            loadMeters();
            loadAllBillReadings().then(() => {
                populateMonthSelect();
                displayBillReadings();
            });

            $("#consumerSelect, #statusSelect, #monthSelect").change(function () {
                currentPage = 1;
                displayBillReadings();
            });

            $("#showBillsBtn").click(fetchBillsForMonth);
        });

        function authHeader() {
            return { "Authorization": "Bearer " + token };
        }

        async function loadConsumers() {
            try {
                const res = await fetch(`${apiBase}/Consumer/AllConsumers`, { headers: authHeader() });
                if (!res.ok) throw new Error("Failed to load consumers");
                const consumers = await res.json();
                const $consumerSelect = $("#consumerSelect");
                $consumerSelect.html('<option value="">-- Select a Consumer --</option>');
                consumers.forEach(consumer => {
                    consumerMap[consumer.consumerId] = consumer.name || consumer.consumerId;
                    $consumerSelect.append(`<option value="${consumer.consumerId}">${consumer.name || consumer.consumerId}</option>`);
                });
            } catch (error) {
                alert("Error loading consumers: " + error.message);
                console.error(error);
            }
        }

        async function loadMeters() {
            try {
                const res = await fetch(`${apiBase}/Meters/AllMeters`, { headers: authHeader() });
                if (!res.ok) throw new Error("Failed to load meters");
                const meters = await res.json();
                meters.forEach(meter => {
                    meterMap[meter.meterId] = meter.meterSerialNo || meter.meterId;
                });
            } catch (error) {
                alert("Error loading meters: " + error.message);
                console.error(error);
            }
        }

        async function loadAllBillReadings() {
            try {
                const res = await fetch(`${apiBase}/BillReading/AllBills`, { headers: authHeader() });
                if (!res.ok) throw new Error("Failed to load bill readings");
                allBills = await res.json();
            } catch (error) {
                alert("Error loading bill readings: " + error.message);
                console.error(error);
            }
        }

        function populateMonthSelect() {
            const uniqueMonths = [...new Set(allBills.map(b => b.billingMonth))].sort();
            const $monthSelect = $("#monthSelect");
            $monthSelect.html('<option value="">-- All Months --</option>');
            uniqueMonths.forEach(month => {
                $monthSelect.append(`<option value="${month}">${month}</option>`);
            });
        }

        async function fetchBillsForMonth() {
            const month = $("#monthSelect").val();
            if (!month) {
                alert("Please select a month first!");
                return;
            }

            try {
                const res = await fetch(`${apiBase}/BillReading/Month/${month}`, { headers: authHeader() });
                if (!res.ok) throw new Error("Failed to fetch or generate bills");

                const data = await res.json();
                if (data.bills) {
                    allBills = data.bills;
                    displayBillReadings();
                    alert(data.message || `Bills for ${month} loaded successfully`);
                } else {
                    alert("Unexpected response format from server.");
                }
            } catch (error) {
                alert("Error generating bills: " + error.message);
                console.error(error);
            }
        }

        function displayBillReadings() {
            const consumerId = $("#consumerSelect").val();
            const status = $("#statusSelect").val();
            const month = $("#monthSelect").val();

            let billsToDisplay = allBills.filter(b => {
                return (!consumerId || b.consumerId == consumerId) &&
                       (!status || b.status === status) &&
                       (!month || b.billingMonth === month);
            });

            if (!billsToDisplay.length) {
                $("#billReadingsTableBody").html(`<tr><td colspan="12" class="text-muted">No bill readings found for the selected filters.</td></tr>`);
                $("#paginationControls").html('');
                return;
            }

            const totalPages = Math.ceil(billsToDisplay.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedBills = billsToDisplay.slice(startIndex, endIndex);

            let rows = "";
            paginatedBills.forEach(b => {
                const consumerName = consumerMap[b.consumerId] || b.consumerId;
                const meterSerialNo = meterMap[b.meterId] || b.meterId;
                const generatedDate = b.generatedDate ? new Date(b.generatedDate).toLocaleString() : '-';
                const remainingBalance = (b.remainingBalance ?? (b.totalBill - (b.amountPaid ?? 0))).toFixed(2);

                rows += `<tr class="${remainingBalance > 0 ? 'table-warning' : 'table-success'}">
                    <td>${b.billId}</td>
                    <td>${consumerName}</td>
                    <td>${meterSerialNo}</td>
                    <td>${b.billingMonth}</td>
                    <td>${b.tariffType}</td>
                    <td>${b.totalConsumption}</td>
                    <td>${b.energyCharge.toFixed(2)}</td>
                    <td>${b.taxAmount.toFixed(2)}</td>
                    <td>${b.totalBill.toFixed(2)}</td>
                    <td>${remainingBalance}</td>
                    <td>${b.status}</td>
                    <td>${generatedDate}</td>
                </tr>`;
            });

            $("#billReadingsTableBody").html(rows);
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            if (totalPages <= 1) {
                $("#paginationControls").html('');
                return;
            }

            let paginationHtml = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
            </li>`;

            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
            }

            paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
            </li>`;

            $("#paginationControls").html(paginationHtml);
        }

        function changePage(page) {
            currentPage = page;
            displayBillReadings();
        }
    </script>
</body>
</html>