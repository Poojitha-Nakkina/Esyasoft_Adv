@{
    ViewData["Title"] = "Meter Management";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container mt-4">
    <h3 class="mb-4 fw-bold"><i class="bi bi-speedometer2"></i> Meter Management</h3>

    <!-- Filters -->
    <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
        <input type="text" id="searchSerial" class="form-control" placeholder="Enter Serial No" style="width: 220px;" />

        <select id="statusFilter" class="form-select" style="width: 150px;">
            <option value="">-- All --</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Decommissioned">Decommissioned</option>
        </select>

        <input type="date" id="dateFilter" class="form-control" style="width: 200px;" />

        <button class="btn btn-success" id="addMeterBtn"><i class="bi bi-plus-lg"></i> New Meter</button>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th>Meter Serial No</th>
                    <th>Consumer ID</th>
                    <th>DTR ID</th>
                    <th>IP Address</th>
                    <th>ICCID</th>
                    <th>IMSI</th>
                    <th>Manufacturer</th>
                    <th>Firmware</th>
                    <th>Category</th>
                    <th>Install Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="meterTableBody"></tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<!-- Add/Edit Meter Modal -->
<div class="modal fade" id="meterModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="meterModalTitle">Add Meter</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="meterForm" class="row g-3">
                    <input type="hidden" id="meterId" />

                    <div class="col-md-6">
                        <label class="form-label">Meter Serial No</label>
                        <input type="text" id="meterSerialNo" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Consumer ID</label>
                        <input type="number" id="consumerId" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">DTR ID</label>
                        <input type="number" id="dtrId" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">IP Address</label>
                        <input type="text" id="ipAddress" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ICCID</label>
                        <input type="text" id="iccid" class="form-control" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">IMSI</label>
                        <input type="text" id="imsi" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Manufacturer</label>
                        <input type="text" id="manufacturer" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Firmware</label>
                        <input type="text" id="firmware" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Category</label>
                        <input type="text" id="category" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Install Date</label>
                        <input type="date" id="installDate" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Status</label>
                        <select id="status" class="form-select">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Decommissioned">Decommissioned</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveMeterBtn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const apiBase = "https://localhost:7285/api/Meters";
    const token = localStorage.getItem("jwtToken");

    let meters = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    document.addEventListener("DOMContentLoaded", async () => {
        await loadMeters();

        document.getElementById("searchSerial").addEventListener("input", filterMeters);
        document.getElementById("statusFilter").addEventListener("change", filterMeters);
        document.getElementById("dateFilter").addEventListener("change", filterMeters);

        document.getElementById("addMeterBtn").addEventListener("click", openAddModal);
        document.getElementById("saveMeterBtn").addEventListener("click", saveMeter);
    });

    async function loadMeters() {
        const res = await fetch(`${apiBase}/AllMeters`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!res.ok) return alert("Failed to load meters");
        meters = await res.json();
        renderTable();
    }

    function filterMeters() {
        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById("meterTableBody");
        tbody.innerHTML = "";

        const search = document.getElementById("searchSerial").value.toLowerCase();
        const status = document.getElementById("statusFilter").value;
        const dateVal = document.getElementById("dateFilter").value;

        let filtered = meters.filter(m => {
            const matchesSerial = m.meterSerialNo?.toLowerCase().includes(search);
            const matchesStatus = !status || m.status === status;

            let matchesDate = true;
            if (dateVal && m.installDate) {
                const meterDate = new Date(m.installDate).toISOString().split('T')[0];
                matchesDate = meterDate === dateVal;
            }
            return matchesSerial && matchesStatus && matchesDate;
        });

        const totalPages = Math.ceil(filtered.length / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage;
        const paginated = filtered.slice(start, start + itemsPerPage);

        if (paginated.length === 0) {
            tbody.innerHTML = `<tr><td colspan="12">No records found</td></tr>`;
        } else {
            paginated.forEach(m => {
                tbody.innerHTML += `
                    <tr>
                        <td>${m.meterSerialNo}</td>
                        <td>${m.consumerId || "-"}</td>
                        <td>${m.dtrid || "-"}</td>
                        <td>${m.ipaddress || "-"}</td>
                        <td>${m.iccid || "-"}</td>
                        <td>${m.imsi || "-"}</td>
                        <td>${m.manufacturer || "-"}</td>
                        <td>${m.firmware || "-"}</td>
                        <td>${m.category || "-"}</td>
                        <td>${m.installDate ? new Date(m.installDate).toLocaleDateString() : "-"}</td>
                        <td>${m.status || "-"}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editMeter(${m.meterId})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMeter(${m.meterId})">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
        }
    }

    function changePage(page) {
        currentPage = page;
        renderTable();
    }

    function openAddModal() {
        document.getElementById("meterForm").reset();
        document.getElementById("meterModalTitle").textContent = "Add Meter";
        new bootstrap.Modal(document.getElementById("meterModal")).show();
    }

    async function editMeter(id) {
        const meter = meters.find(m => m.meterId === id);
        if (!meter) return;

        document.getElementById("meterId").value = meter.meterId;
        document.getElementById("meterSerialNo").value = meter.meterSerialNo;
        document.getElementById("consumerId").value = meter.consumerId;
        document.getElementById("dtrId").value = meter.dtrid;
        document.getElementById("ipAddress").value = meter.ipaddress;
        document.getElementById("iccid").value = meter.iccid;
        document.getElementById("imsi").value = meter.imsi;
        document.getElementById("manufacturer").value = meter.manufacturer;
        document.getElementById("firmware").value = meter.firmware;
        document.getElementById("category").value = meter.category;
        document.getElementById("installDate").value = meter.installDate ? meter.installDate.split('T')[0] : "";
        document.getElementById("status").value = meter.status;

        document.getElementById("meterModalTitle").textContent = "Edit Meter";
        new bootstrap.Modal(document.getElementById("meterModal")).show();
    }

    async function saveMeter() {
        const id = document.getElementById("meterId").value;
        const data = {
            meterId: id ? parseInt(id) : 0,
            meterSerialNo: document.getElementById("meterSerialNo").value,
            consumerId: parseInt(document.getElementById("consumerId").value),
            dtrid: parseInt(document.getElementById("dtrId").value),
            ipaddress: document.getElementById("ipAddress").value,
            iccid: document.getElementById("iccid").value,
            imsi: document.getElementById("imsi").value,
            manufacturer: document.getElementById("manufacturer").value,
            firmware: document.getElementById("firmware").value,
            category: document.getElementById("category").value,
            installDate: document.getElementById("installDate").value,
            status: document.getElementById("status").value
        };

        const url = id ? `${apiBase}/UpdateMeters/${id}` : `${apiBase}/addMeters`;
        const method = id ? "PUT" : "POST";

        const res = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            alert("Meter saved successfully!");
            await loadMeters();
            bootstrap.Modal.getInstance(document.getElementById("meterModal")).hide();
        } else {
            alert("Error saving meter.");
        }
    }

    async function deleteMeter(id) {
        if (!confirm("Are you sure you want to delete this meter?")) return;
        const res = await fetch(`${apiBase}/DeleteMeter/${id}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.ok) {
            alert("Meter deleted successfully!");
            await loadMeters();
        } else {
            alert("Error deleting meter.");
        }
    }
</script>