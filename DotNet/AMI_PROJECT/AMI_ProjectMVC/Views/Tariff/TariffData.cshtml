@{
    ViewData["Title"] = "Tariff Management";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container mt-5" id="tariffSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Tariff List</h2>
        <button id="addTariffBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTariffModal">
            ➕ Add Tariff
        </button>
    </div>

    <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Effective From</th>
                <th>Effective To</th>
                <th>Base Rate</th>
                <th>Tax Rate</th>
                <th id="actionHeader">Actions</th>
            </tr>
        </thead>
        <tbody id="tariffTableBody"></tbody>
    </table>
</div>

<!-- Add Tariff Modal -->
<div class="modal fade" id="addTariffModal" tabindex="-1" aria-labelledby="addTariffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addTariffForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTariffModalLabel">Add New Tariff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                    <div class="col-md-6">
                        <label for="tariffName" class="form-label">Name</label>
                        <input type="text" id="tariffName" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label for="baseRate" class="form-label">Base Rate</label>
                        <input type="number" id="baseRate" class="form-control" step="0.01" required />
                    </div>
                    <div class="col-md-6">
                        <label for="taxRate" class="form-label">Tax Rate (%)</label>
                        <input type="number" id="taxRate" class="form-control" step="0.01" required />
                    </div>
                    <div class="col-md-6">
                        <label for="effectiveFrom" class="form-label">Effective From</label>
                        <input type="date" id="effectiveFrom" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label for="effectiveTo" class="form-label">Effective To</label>
                        <input type="date" id="effectiveTo" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Tariff</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Tariff Modal -->
<div class="modal fade" id="editTariffModal" tabindex="-1" aria-labelledby="editTariffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editTariffForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTariffModalLabel">Edit Tariff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                    <input type="hidden" id="editTariffId" />
                    <div class="col-md-6">
                        <label for="editTariffName" class="form-label">Name</label>
                        <input type="text" id="editTariffName" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label for="editBaseRate" class="form-label">Base Rate</label>
                        <input type="number" id="editBaseRate" class="form-control" step="0.01" required />
                    </div>
                    <div class="col-md-6">
                        <label for="editTaxRate" class="form-label">Tax Rate (%)</label>
                        <input type="number" id="editTaxRate" class="form-control" step="0.01" required />
                    </div>
                    <div class="col-md-6">
                        <label for="editEffectiveFrom" class="form-label">Effective From</label>
                        <input type="date" id="editEffectiveFrom" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label for="editEffectiveTo" class="form-label">Effective To</label>
                        <input type="date" id="editEffectiveTo" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const apiBase = "https://localhost:7285/api/Tariffs";
    const token = localStorage.getItem("jwtToken");
    const role = (localStorage.getItem("role") || "").toLowerCase();

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("tariffSection").style.display = "block";
        loadTariffs();

        if (role !== "superadmin" && role !== "zoneadmin") {
            document.getElementById("addTariffBtn").style.display = "none";
            document.getElementById("actionHeader").style.display = "none";
        }
    });

    // ✅ Load tariffs
    async function loadTariffs() {
        const res = await fetch(`${apiBase}/GetAllTariffs`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) {
            console.error("Error fetching tariffs:", res.status);
            return;
        }

        const data = await res.json();
        const tbody = document.getElementById("tariffTableBody");
        tbody.innerHTML = "";

        data.forEach(t => {
            const actions = (role === "superadmin" || role === "zoneadmin")
                ? `<td>
                        <button class="btn btn-sm btn-warning me-2" onclick="openEditTariff(${t.tariffId})">✏ Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTariff(${t.tariffId})">🗑 Delete</button>
                   </td>`
                : "";

            tbody.innerHTML += `
                <tr>
                    <td>${t.tariffId}</td>
                    <td>${t.name}</td>
                    <td>${t.effectiveFrom?.split('T')[0] || "-"}</td>
                    <td>${t.effectiveTo?.split('T')[0] || "-"}</td>
                    <td>${t.baseRate}</td>
                    <td>${t.taxRate}</td>
                    ${actions}
                </tr>`;
        });
    }

    // ✅ Add Tariff
    document.getElementById("addTariffForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (role !== "superadmin" && role !== "zoneadmin") return alert("Access denied");

        const newTariff = {
            name: tariffName.value,
            baseRate: parseFloat(baseRate.value),
            taxRate: parseFloat(taxRate.value),
            effectiveFrom: effectiveFrom.value,
            effectiveTo: effectiveTo.value
        };

        const res = await fetch(`${apiBase}/CreateTariff`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
            body: JSON.stringify(newTariff)
        });

        if (res.ok) {
            alert("Tariff added successfully!");
            bootstrap.Modal.getInstance(addTariffModal).hide();
            addTariffForm.reset();
            loadTariffs();
        } else alert("Error adding tariff");
    });

    // ✅ Open Edit Modal
    async function openEditTariff(id) {
        const res = await fetch(`${apiBase}/GetTariffById/${id}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!res.ok) return alert("Error fetching tariff");

        const t = await res.json();
        editTariffId.value = t.tariffId;
        editTariffName.value = t.name;
        editBaseRate.value = t.baseRate;
        editTaxRate.value = t.taxRate;
        editEffectiveFrom.value = t.effectiveFrom?.split('T')[0] || "";
        editEffectiveTo.value = t.effectiveTo?.split('T')[0] || "";

        new bootstrap.Modal(editTariffModal).show();
    }

    // ✅ Save Edits
    document.getElementById("editTariffForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (role !== "superadmin" && role !== "zoneadmin") return alert("Access denied");

        const updatedTariff = {
            tariffId: parseInt(editTariffId.value),
            name: editTariffName.value,
            baseRate: parseFloat(editBaseRate.value),
            taxRate: parseFloat(editTaxRate.value),
            effectiveFrom: editEffectiveFrom.value,
            effectiveTo: editEffectiveTo.value
        };

        const res = await fetch(`${apiBase}/UpdateTariff/${updatedTariff.tariffId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
            body: JSON.stringify(updatedTariff)
        });

        if (res.ok) {
            alert("Tariff updated successfully!");
            bootstrap.Modal.getInstance(editTariffModal).hide();
            loadTariffs();
        } else alert("Error updating tariff");
    });

    // ✅ Delete Tariff
    async function deleteTariff(id) {
        if (role !== "superadmin" && role !== "zoneadmin") return alert("Access denied");
        if (!confirm("Are you sure you want to delete this tariff?")) return;

        const res = await fetch(`${apiBase}/DeleteTariff/${id}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (res.ok) {
            alert("Tariff deleted successfully!");
            loadTariffs();
        } else alert("Error deleting tariff");
    }
</script>